 **继续深度学习模型的数据表的建立。**
 - 主要步骤为分批处理CRSP中数据，并将宏观数据变量与前一天处理的数据表进行连接。
 
  自科部分明天会安排时间重新梳理思路。
  - 工作安排倾向于分部分重新梳理逻辑，然后分部分依次重写。
  - 另外原来的文献梳理应该是有用的，但书写思路理清是首要工作。

数据表关键代码如下：
```python
import pandas as pd

def convert_date(src_format):
    import datetime
    aim_format = '%Y-%m-%d'
    datetime = datetime.datetime.strptime(src_format, aim_format)
    return datetime.date().strftime('%Y%m%d')

def re_to_csv(src_file):
    df = pd.read_csv(src_file+'.csv' ,low_memory = False)
    df = df.drop(columns = 'Unnamed: 0')
    df['DATE'] = df['DATE'].apply(lambda x: convert_date(x))
    df['fyearq'] = df['DATE'].str[:4].astype(int)
    df['month'] = df['DATE'].str[4:6].astype(int)
    df.to_csv(src_file+'.gz', compression='gzip', index=False)
```

```python
import pandas as pd
def merge_ibes_comp(df_ibes,df_comp):
    df_ibes['cusip'] = df_ibes['CUSIP']
    df_comp = df_comp.drop(columns = 'Unnamed: 0')
    df_comp['cusip'] = df_comp['cusip'].str[:8]
    df_comp['datadate'] = df_comp['datadate'].astype(str)
    df = df_comp.merge(df_ibes, on=['cusip','datadate','fyearq'],how = 'left')
    df = df.drop(columns = ['quarter','month'])
    df['fqtr'] = df['fqtr'].astype(int)
    return df.dropna()

def merge_dfnew_dfcomp(df_new,df_comp):
    df_comp = df_comp.drop(columns = 'Unnamed: 0')
    df_comp['datadate'] = df_comp['datadate'].astype(str)
    df = df_new.merge(df_comp,on=['gvkey','datadate','fyearq','fqtr','fyr'],how = 'left')
    df = df.dropna()
    df = df.drop(columns = ['cusip_x'])
    df = df.rename(columns = {'cusip_y':'cusip'})
    return df
```