#### 数据库连接代码
```python
# -*- coding: utf-8 -*-
import pandas as pd
import numpy as np
#读取数据集
comp_names = pd.read_csv('compustat/compustat_csv/pg3kvcrgqxouino0.csv')
#过滤数据集，只包括tic为“DELL”，“IBM”，“MSFT”，“F”，“DIS”的观测值
compcusip = comp_names[comp_names['tic'].isin(["DELL","IBM","MSFT","F","DIS"])]
#通过提取cusip的前8个字符来创建一个新变量cusip8
compcusip['cusip8'] = compcusip['cusip'].str[:8]
#读取数据集
crsp_stocknames = pd.read_csv("crsp/CRSP_csv/nflf09usrwj5zkii.csv")
#按cusip对数据进行排序并删除重复项
crspcusip = crsp_stocknames.sort_values("CUSIP").drop_duplicates(subset=["CUSIP"])
#只选择cusip、permco和permno列
crspcusip = crspcusip[["CUSIP","PERMCO","PERMNO"]]
# 合并cusip8和cusip上的两个数据帧
total = pd.merge(compcusip,crspcusip, left_on='cusip8', right_on='CUSIP', how='inner')
# 定义日期范围
fyear1 = 1984
fyear2 = 2014
# 定义选定的数据项
# vars = ['gvkey', 'datadate', "fyearq",'fyr', 'saleq', 'atq', 'indfmt','datafmt',
#         'popsrc','consol']
comp_funda = comp_names
# 定义gvkey
glist = code = list(set(comp_funda['gvkey']))
compx2 = comp_funda
# 创建endfyr和begfyr列
compx2 = compx2[compx2["gvkey"].isin(glist) & (compx2["fyearq"] >= fyear1) & (compx2["fyearq"] <= fyear2)]
compx2["endfyr"] = compx2["datadate"]
compx2["begfyr"] = pd.to_datetime(compx2["datadate"]) - pd.DateOffset(months=11)
# 计算sxa列-营业额(净)/资产= 财务比率 或 资产利用效率
compx2["sxa"] = compx2["saleq"] / compx2["atq"]
# 只保留相关的列
compx2 = compx2[["gvkey", "begfyr", "endfyr", "sxa", "fyr", "fyearq"]]
mydata = pd.merge(compx2, total, on='gvkey', how='inner')
# 导入数据
crsp_msf = crspcusip
#匹配财政年度的结束
mydata['endfyr'] = pd.to_datetime(mydata['endfyr'])
mydata['date_month'] = mydata['endfyr'].dt.month
mydata['date_year'] = mydata['endfyr'].dt.year
crsp_msf['YYYYMMDD'] = pd.to_datetime(crsp_msf['YYYYMMDD'])
crsp_msf['date_month'] = crsp_msf['YYYYMMDD'].dt.month
crsp_msf['date_year'] = crsp_msf['YYYYMMDD'].dt.year
# 内部联接mydata和crsp_msf的permno（永久公司代码）和日期
mydata2 = mydata.merge(crsp_msf, on=['PERMNO','date_month','date_year'], how='inner')
# 取出所需字段
var = ['gvkey','datadate','fyearq','fyr','fqtr','cusip','openprc','prc','ret',
       'invtq','revtq', 'rectq','revtq', 'capxy', 'cogsq', 'xsgaq','saleq',
      'vwretd','vwretx','ewretx','ewretd']
 # 'fyearq','fyr','fqtr','cusip','openprc','prc','ret',
mylocal_ccmfundaex = mydata2[var]
# print(mylocal_ccmfundaex) 
mylocal_ccmfundaex.to_csv("mylocal_ccmfundaex.csv", index=False)
```

连接后的数据表保存有1984至2014年所需的crsp与compustat对应字段（var）的全部信息

---
#### 财报滞后期取长
取5年（2 x 4 x 5 = 40)财报使用取出最重要的财报滞后期，以确定y在模型中最佳滞后期的选择：
```python
import pandas as pd

data_src = pd.read_csv(r"年、中、季报基本情况文件185022453\IAR_Rept.csv")
mydata = data_src[['Stkcd','Annodt','Erana']]
mydata['earning_change_rate'] = mydata['Erana'].diff()
# data = mydata[0:208]
data = mydata
data = data.groupby('Stkcd')
def lag(start,end):
    length = list(range(start,end+1,1))
    res = []
    for group_name,group_df in data:
        group_df.reset_index(inplace=True)
        for lag in length:
            col_name = "rate_lag" + str(lag)
            group_df[col_name] = group_df['Erana'].shift(lag)
        res.append(group_df)
    res = pd.concat(res)
    return res

res = lag(0,40)
mydata = mydata.merge(res, on=['Stkcd','Erana','earning_change_rate','Annodt'])
mydata = mydata.drop(['index'], axis=1)
mydata = mydata.dropna()
mydata.to_csv("earning_change_rate_lag.csv", index=False)
```

处理后，数据格式如下：

|Stkcd|Annodt|Erana|earning_change_rate|rate_lag0|...|...|rate_lag40|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|

储存0至40期滞后财报变化速率

使用算法计算出其中重要特征：
```R
# 1 数据导入
library(Boruta)
data_all <- read.csv("G:\\Data\\midar_data\\old_midasr_data\\0First_data\\earning_change_rate_lag.csv",sep=',' , encoding='UTF-8')
mydata <- data_all[,-(1:3)]
data <- na.omit(mydata)
boruta <- Boruta(earning_change_rate ~ ., data = data, doTrace = 2, maxRuns = 500)
print(boruta)
```

数据运行有点太久了 明天再查看结果

---
### PCA 对日度股票特征进行压缩
参考链接：[R 中的 PCA 回归 (koalatea.io)](https://koalatea.io/r-pca-regression/)
输入财报变化率和0至20期股票数据
```R
# 1 数据导入
library(MASS)
data_all <- read.csv("G:\\Data\\midar_data\\src_data\\Result_0_20.csv",sep=',' , encoding='UTF-8')
## 删除前5列和第1到lag（最大滞后期）行
lag <- 20
mydata <- data_all[-c(1:lag), -(1:5)]
mydata <- na.omit(mydata)
## 将Erana列进行差分，第一个数是2001第四季度与2002第一季度财报差分值
data<- mydata[!duplicated(mydata$Erana),]
data$Erana <- c (diff(c(0.21,0.09)),diff(data$Erana))
## 保留第一个重复/去所有的重复
rownames(data)<-1:nrow(data)
# 2 特征压缩
data.preds <- subset(data, select=-c(Erana))
data.pca <- prcomp(data.preds, center = TRUE, scale = TRUE)
plot(data.pca)
```

```R
Standard deviations (1, .., p=21):
 [1] 4.54901686 0.29052699 0.18794621 0.17178072 0.15004508
 [6] 0.13645940 0.12363328 0.11322826 0.10530526 0.09827516
[11] 0.09404605 0.08981399 0.08537467 0.08383309 0.07785993
[16] 0.07696506 0.07394867 0.07284316 0.06749855 0.06620073
[21] 0.06551834

Rotation (n x k) = (21 x 21):
              PC1          PC2         PC3          PC4
stock0  0.2183405 -0.122308188  0.13598266 -0.343329264
stock1  0.2184972 -0.091410621  0.15397016 -0.333698612
stock2  0.2184531 -0.149535901  0.11833254 -0.258665391
stock3  0.2185542 -0.161645635  0.13622707 -0.164749929
stock4  0.2184765 -0.153079814  0.15005229 -0.069248557
stock5  0.2186145 -0.136476572  0.13308842 -0.067475612
stock6  0.2186428 -0.129728437  0.18086530 -0.001637903
stock7  0.2184843 -0.100844351  0.19857405  0.074927349
stock8  0.2185289 -0.086294216  0.15927599 -0.010649960
stock9  0.2185421 -0.113581569  0.14600574  0.198029313
stock10 0.2185585 -0.096475602  0.01538941  0.337970303
stock11 0.2185923 -0.107941650 -0.01071419  0.401016603
stock12 0.2182927 -0.108107295 -0.10992305  0.422673962
stock13 0.2185381 -0.076878698 -0.15841085  0.258549906
stock14 0.2184230  0.042587673 -0.41237086 -0.048043222
stock15 0.2182861  0.009670007 -0.37440170 -0.006651822
stock16 0.2183755  0.039678923 -0.42425657 -0.213324358
stock17 0.2183295  0.081708275 -0.33971173 -0.215937704
stock18 0.2180818  0.310423678 -0.11773814 -0.042166257
stock19 0.2170818  0.497163489  0.11421149  0.008682961
stock20 0.2148502  0.668236465  0.31003801  0.074458416
                 PC5         PC6          PC7         PC8
stock0   0.148210738 -0.42325183  0.013943828 -0.10017912
stock1  -0.075134198 -0.40472581  0.006259198 -0.24797905
stock2   0.247194831 -0.01679665  0.095071060 -0.04174940
stock3   0.258073064  0.03424814  0.140476134  0.13586358
stock4   0.295766451  0.34738741  0.065439272  0.14416779
stock5   0.182218275  0.39472322 -0.168652340  0.14340092
stock6  -0.153337381  0.37296555 -0.218059699 -0.03071567
stock7  -0.431284556  0.13908870 -0.266509879 -0.10640399
stock8  -0.453530574 -0.05326101 -0.117430743 -0.05402656
stock9  -0.310099009 -0.18717675  0.232488569  0.27553355
stock10 -0.051776678 -0.17267425  0.278706800  0.30079956
stock11  0.060336520 -0.10807891  0.178022409  0.02970554
stock12  0.306065895 -0.02449896  0.114608713 -0.34012980
stock13  0.117973573 -0.05946633 -0.329120572 -0.43286054
stock14  0.004430418 -0.06983883 -0.324841182 -0.06181934
stock15  0.097603679 -0.17569486 -0.355791829  0.48783293
stock16 -0.130126398  0.05388897  0.083295007  0.16758696
stock17 -0.218463681  0.24866736  0.382394522 -0.10554464
stock18 -0.043729121  0.16383855  0.311442151 -0.28363766
stock19  0.002072194  0.03266180  0.062807014 -0.01821119
stock20  0.150308800 -0.09362264 -0.186576583  0.13995933
                 PC9        PC10        PC11        PC12
stock0   0.282927534 -0.34834523  0.09162232 -0.15840622
stock1   0.190305693  0.02271432  0.10619149  0.07496959
stock2  -0.141956276  0.62358987 -0.24045199  0.26444175
stock3  -0.414505388  0.15837250  0.01854394 -0.22982601
stock4  -0.261496588 -0.36625445  0.18822816  0.10001920
stock5   0.327362533 -0.23164572 -0.10375718  0.10386237
stock6   0.369613881  0.11954786 -0.09166521 -0.01871091
stock7   0.002803161  0.26084505  0.32464439 -0.14761199
stock8  -0.439467260 -0.22578761 -0.09178484 -0.15720998
stock9  -0.168982177 -0.11767191 -0.14148278  0.23794148
stock10  0.211010075 -0.04512413 -0.05669851  0.33120694
stock11  0.253054214  0.19465761 -0.01045681 -0.22512725
stock12 -0.064896792 -0.09551739  0.09218227 -0.35619192
stock13 -0.123983803  0.02361257 -0.24190869  0.18032970
stock14 -0.098799126 -0.18613560 -0.12495898  0.37435487
stock15 -0.022162060  0.17942158  0.47406718 -0.09232662
stock16  0.043780393  0.01075396 -0.39891691 -0.30223289
stock17  0.095388053 -0.01798271 -0.05618218 -0.17712426
stock18 -0.062862095 -0.01389829  0.41189076  0.28670533
stock19  0.057520968  0.10030360  0.12369702  0.10360709
stock20 -0.035219826 -0.04574280 -0.27530343 -0.19541280
               PC13         PC14        PC15         PC16
stock0   0.19485266 -0.097978427  0.01956234 -0.050640506
stock1  -0.24952817  0.162022061  0.05713700 -0.006827414
stock2   0.09175941 -0.292813671  0.17662195  0.298269379
stock3  -0.14557932  0.326464601 -0.48541868 -0.364510618
stock4  -0.14448261  0.056317983  0.36014073  0.126146039
stock5   0.22056966 -0.069630461 -0.18694818  0.146514588
stock6  -0.01778276 -0.049761632 -0.05393444 -0.359336536
stock7  -0.34239342  0.017942253  0.17312544  0.053763328
stock8   0.28914133 -0.041696221 -0.19301289  0.382946245
stock9   0.14576061 -0.317329606  0.16005197 -0.419514571
stock10 -0.25536954  0.416308173  0.04005498  0.197022325
stock11  0.14855536 -0.115680190 -0.33950011  0.197629687
stock12 -0.20563220 -0.324082104  0.14081773 -0.015582677
stock13  0.34815236  0.466644011  0.19394954 -0.164383396
stock14 -0.43093520 -0.271742440 -0.39752910  0.064492168
stock15  0.25155560  0.028085110  0.12358903  0.029732515
stock16 -0.08128752 -0.058786715  0.25875882 -0.231735846
stock17  0.03451247  0.239936772  0.01483834  0.269366988
stock18  0.16029804 -0.111514398 -0.02235532 -0.159529890
stock19  0.14292897  0.006168829 -0.18197751 -0.100255843
stock20 -0.15666909  0.031034868  0.14393353  0.107606009
                PC17         PC18          PC19        PC20
stock0   0.241741488  0.157089711  0.2482642830  0.39905684
stock1  -0.347506414 -0.164808822 -0.2636472222 -0.46145308
stock2   0.137770188  0.004730729  0.0746296859  0.03406657
stock3   0.088510401 -0.058887621 -0.0782495448  0.09430503
stock4  -0.363699389  0.214584779  0.2097353031 -0.02752830
stock5   0.030265592 -0.131626066 -0.4677814310 -0.02938230
stock6   0.177191893 -0.098242875  0.3324949255 -0.21771194
stock7  -0.004238057  0.143029439 -0.0936899951  0.39197064
stock8   0.193733068  0.112012234 -0.0003560645 -0.28295029
stock9  -0.202033925 -0.316406420 -0.0044390189  0.12175885
stock10  0.405946541  0.138840364  0.0209261656 -0.06981250
stock11 -0.488784677  0.231246100 -0.0531213639  0.15357632
stock12  0.254799504 -0.195976984  0.0252268930 -0.26903691
stock13 -0.104085426  0.015584506  0.0038605744  0.13164187
stock14 -0.066449164 -0.017495258  0.1312384364  0.13615883
stock15  0.043379239 -0.192455684  0.0127684470 -0.12919868
stock16  0.006899253  0.468727343 -0.2246194495 -0.11958070
stock17 -0.099572916 -0.487054965  0.2461039075  0.17168885
stock18  0.200059629  0.121078227 -0.3887069015  0.10037933
stock19 -0.122232596  0.268655311  0.4133390967 -0.29242717
stock20  0.018529606 -0.214522353 -0.1440228488  0.16566937
                PC21
stock0   0.016472477
stock1  -0.045090277
stock2   0.004767921
stock3   0.042270922
stock4  -0.166171444
stock5   0.378259664
stock6  -0.445038148
stock7   0.284261062
stock8  -0.132084487
stock9   0.138834176
stock10 -0.002319117
stock11 -0.265443184
stock12  0.185434876
stock13  0.047453134
stock14 -0.038642065
stock15 -0.071569031
stock16  0.051352867
stock17  0.063427578
stock18 -0.313533565
stock19  0.490631082
stock20 -0.224069351
```
（所有股票数据）从上面的结果可以看出，模型对原始数据进行了降维，从 21 维降到了 21 维。 
- Standard deviations 的结果表示了每一个主成分贡献的大小。
- 第一个数字 4.54901686 是第一主成分贡献的大小，后面的数字依次类推
- Rotation 的结果表示了每个股票在每个主成分上的贡献。
	比如说，第一行第一列 0.2183405 表示第一只股票在第一个主成分上的贡献。
```r
library(pls)
model = pcr(Erana ~ ., data = data, scale = TRUE)
summary(model)
```

```R
Data: 	X dimension: 11234 21 
	Y dimension: 11234 1
Fit method: svdpc
Number of components considered: 21
TRAINING: % variance explained
         1 comps   2 comps   3 comps  4 comps  5 comps  6 comps
X      98.540735  98.94267  99.11088  99.2514  99.3586   99.447
Erana   0.009087   0.02542   0.08548   0.1382   0.1403    0.141
       7 comps  8 comps  9 comps  10 comps  11 comps  12 comps
X      99.5201  99.5811  99.6339   99.6799   99.7220   99.7604
Erana   0.1548   0.1584   0.1584    0.2048    0.2055    0.3275
       13 comps  14 comps  15 comps  16 comps  17 comps  18 comps
X       99.7951   99.8286   99.8575   99.8857   99.9117   99.9370
Erana    0.3497    0.4164    0.4173    0.4175    0.4176    0.4314
       19 comps  20 comps  21 comps
X       99.9587   99.9796  100.0000

Erana    0.4315    0.4457    0.4602
```
以上使用了PCR 进行了降维和回归分析，考虑了 21 个主成分。
TRAINING 部分给出了每个主成分所解释的方差百分比
- 例如，当使用1个主成分时，X变量解释了98.540735％的方差，而Erana变量只解释了0.009087％的方差。随着使用的主成分数量的增加，X变量和Erana变量所解释的方差都增加。在使用21个主成分时，X变量解释了100%的方差。
- 最后一行显示了在使用21个主成分时，X变量和Erana变量所解释的方差百分比。可以看到，X变量解释了100%的方差，而Erana变量解释了0.4602%的方差。这意味着使用21个主成分足以解释X变量的所有变化，而Erana变量对于解释X变量的变化贡献很小。

PCA 后可以构建模型
```r
set.seed(1)

model <- train(
  Erana ~ .,
  data = data,
  method = 'lm',
  preProcess = c("pca")
)
model
```

```R
Linear Regression 

11234 samples
   21 predictor

Pre-processing: principal component signal extraction (21),
 centered (21), scaled (21) 
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 11234, 11234, 11234, 11234, 11234, 11234, ... 
Resampling results:

  RMSE      Rsquared      MAE      
  1.162594  0.0005261924  0.4749884

Tuning parameter 'intercept' was held constant at a value of TRUE
```
其中RMSE 是 1.162594 ， Rsquared 是  0.0005261924 。