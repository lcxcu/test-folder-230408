1. 分析师特征模仿选取
![[1675439645869.png]]
![[1675439675725.png]]

2. 
   计算**资本支出**（capital expenditures）
	- ∆Industry $CAPX_q$ −∆Firm $CAPX_q$ (CAPXY) 表示企业资本支出的变化减去公司资本支出的变化。今天完善了该变量的计算

3. 开始计算月度数据变量 其中分批CRSP的读取仍是难点。
计算超额股票回报的计算时，其中除了CRSP的读取，Fama-French 10个行业对齐也是着重思考的点。
   
```python
# k=3
k = 3
var1 = 'SIC'.lower() # 行业
var2 = 'CAPXY'.lower()
new_var = 'capital_expenditures'
import pandas as pd
# 读入compustat文件
df_compu = pd.read_csv("compustat/compustat_csv/compustat_csv.csv"
                       ,usecols=['gvkey','datadate','fyearq','fyr','fqtr','cusip',var1,var2],dtype={var1:str},low_memory=False)
                       import pandas as pd
# 读入IPortfolios文件
df_IPortfolios = pd.read_csv("10_Industry_Portfolios_CSV/10_Industry_Portfolios.CSV"
                      , skiprows=11 ,low_memory=False)
df_IPortfolios = df_IPortfolios.rename(columns={'Unnamed: 0':'Datadate'})
df_IPortfolios = df_IPortfolios.iloc[0:1157,:] # 只取月度投资组合收益
# 读取其中行业分类
industry = list(df_IPortfolios.columns)[1:-1]
import numpy as np
scope = ["0100-0999\n2000-2399\n2700-2749\n2770-2799\n3100-3199\n3940-3989",
        " 2500-2519\n2590-2599\n3630-3659\n3710-3711\n3714-3714\n3716-3716\n3750-3751\n3792-3792\n3900-3939\n3990-3999",
        "2520-2589\n2600-2699\n2750-2769\n2800-2829\n2840-2899\n3000-3099\n3200-3569\n3580-3621\n3623-3629\n3700-3709\n3712-3713\n3715-3715\n3717-3749\n3752-3791\n3793-3799\n3860-3899",
        "1200-1399\n2900-2999",
        "3570-3579\n3622-3622\n3660-3692\n3694-3699\n3810-3839\n7370-7372\n7373-7373\n7374-7374\n7375-7375\n7376-7376\n7377-7377\n7378-7378\n7379-7379\n7391-7391\n8730-8734",
        "4800-4899",
        "5000-5999\n7200-7299\n7600-7699",
        "2830-2839\n3693-3693\n3840-3859\n8000-8099", 
        "4900-4949"]

def convert_ranges(ranges_string):
    ranges = ranges_string.strip().split("\n")
    result = []
    for r in ranges:
        start, end = r.strip().split("-")
        result.append(range(int(start),int(end)))
    return result

range_list = list(map(lambda x: convert_ranges(x), scope)) # 对应SIC生成的range范围range_list 
industry_dict = dict(zip(industry, range_list))# 将对应行业与range_list的中的范围对应起来
df_compu['sic'] = df_compu['sic'].fillna(0)
def in_ranges(num, ranges): # 判断该代码是否在对应范围中
    if num == np.nan:
        return False
    num = int(num)
    for r in ranges:
        if num in r:
            return True
    return False

def map_industry(code,industry_dict): # 返回对应行业
    for k in industry_dict:
        if in_ranges(code,industry_dict[k]):
            return k
    return np.nan
df_compu['industry'] = df_compu['sic'].apply(lambda x : map_industry(x,industry_dict))
df_compu['industry'] = df_compu['industry'].fillna('Other')
import warnings
warnings.filterwarnings('ignore') # 忽略警告
df_IPortfolios['fyearq'] = df_IPortfolios['Datadate'].str[:4].astype(int)
df_IPortfolios['month'] = df_IPortfolios['Datadate'].str[4:].astype(int)

def quarter_of_month(month):
    if month in [1, 2, 3]:
        return 1
    elif month in [4, 5, 6]:
        return 2
    elif month in [7, 8, 9]:
        return 3
    else:
        return 4

df_IPortfolios['fqtr'] = df_IPortfolios['month'].apply(quarter_of_month)
df = df_compu.merge(df_IPortfolios,on =['fyearq','fqtr'],how = 'left')
df_industry = df.iloc[:,-11:-1] # 取时间按月对齐后的行业资产，便于后面按季度加总
grouped = [(df_industry.iloc[i:i+3].astype(np.float64)).sum() for i in range(0, df_industry.shape[0], 3)]
df_compu_industry = pd.DataFrame(grouped)
df_compu_industry ['fyearq'] = df_compu['fyearq'].astype(int)
df_compu_industry ['fqtr'] = df_compu['fqtr'].astype(int)
df_compu_industry = df_compu.merge(df_industry, on =['fyearq','fqtr'])
df_compu_industry['industry_capxq'] = [df_compu_industry[df_compu_industry ['industry'][i]] [i] for i in range(len(df_compu_industry))] 
df_compu = df_compu_industry.drop(columns=list(df_IPortfolios.columns)[1:-3])
k = 3
var1 = 'industry_capxq'
new_var = 'capital expenditures'
def create_new_variable(var1,var2,new_var,fyear1,fyear2):
    df_compu2 = df_compu.dropna() 
    df_compu2['delta_'+var1] = df_compu2[var1].diff()
    df_compu2['delta_'+var2] = df_compu2[var2].diff()
    df_compu2[new_var] = df_compu2['delta_'+var1]-df_compu2['delta_'+var2]
    df_compu2 = df_compu2.drop(columns=[var1,var2,'delta_'+var1,'delta_'+var2])
    df_compu2 = df_compu2[(df_compu2["fyearq"] >= fyear1) & (df_compu2["fyearq"] <= fyear2)]
    return df_compu2 
# 定义日期范围
fyear1 = 1984
fyear2 = 2014
df_compu2 = create_new_variable(var1,var2,new_var,fyear1,fyear2)
df_compu2.to_csv("src_quarterly/"+str(k)+"_"+new_var+".csv")
```