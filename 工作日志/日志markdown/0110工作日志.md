
## 数据整理
令数据表结构如下：
每次取20个连续的时期，选出20个里最重要的特征，从该特征开始再往后推20个时期

|Code|Date|earning|stock1|stock2|...|stock20|
|-|-|-|-|-|-|-|



```python
import pandas as pd
import math

def connect_xlsx():
    daily = pd.read_csv('G:\\Data\\midar_data\\src_data\\Fin_Daily_all.csv')
    quarter = pd.read_csv('G:\\Data\\midar_data\\src_data\\Fin_Quarter_all.csv')

    daily_year = daily.Trddt.apply(lambda x: int(x.split('-')[0]))
    daily['Year'] = daily_year
    daily_Reptyp = daily.Trddt.apply(lambda x: math.ceil(int(x.split('-')[1])/3))  #月份/3 向上取整即是季度
    daily['Reptyp'] = daily_Reptyp
    quarter_year = quarter.Accper.apply(lambda x: int(x.split('/')[0]))
    quarter['Year'] = quarter_year

    res = pd.merge(left=daily,right=quarter,on=["Stkcd","Year","Reptyp"])
    del res['Year']
    del res['Annodt']
    del res['Trddt']  #把不需要的字段都删除
    return res

def select_lag(start,end):
    data = connect_xlsx() #调用函数 此处数据选用连接后的数据
    data = data.groupby('Stkcd')
    length = list(range(start,end+1,1))

    res = []
    for group_name,group_df in data:
        group_df.reset_index(inplace=True)
        for lag in length:
            col_name = "stock" + str(lag)
            group_df[col_name] = group_df['ChangeRatio'].shift(lag)  #将ChangeRatio向下平移lag个单位 对齐后即是滞后期对应值
        res.append(group_df)

    res = pd.concat(res)
    res.to_csv('G:\\Data\\midar_data\\src_data\\Result.csv',index=False)


if __name__ =='__main__':
    select_lag(0,20)



```

#### 数据导入
```R
library(Boruta)
library(mlbench)
library(caret)
library(randomForest)
data_all <- read.csv("G:\\Data\\midar_data\\src_data\\Result.csv",sep=',' , encoding='UTF-8')
# 删除前5列和第1到18行
mydata <- data_all[-c(1:20), -(1:5)]
mydata <- na.omit(mydata)
# 保留第一个重复/去所有的重复
data<- mydata[!duplicated(mydata$Erana),]
rownames(data)<-1:nrow(data)
```

#### 特征选择
```R
set.seed(123)
boruta <- Boruta(Erana ~ ., data = data, doTrace = 2, maxRuns = 500)
print(boruta)
```
结果如下：
```R
Boruta performed 19 iterations in 5.012871 mins.
 21 attributes confirmed important: stock0, stock1, stock10,
stock11, stock12 and 16 more;
 No attributes deemed unimportant.
```

```R
plot(boruta, las = 1, cex.axis = 0.7)
```
![[Pasted image 20230111031654.png]]
```R
plotImpHistory(boruta)
```
![[Pasted image 20230111031719.png]]

按照结论来看，代入的滞后期需延长或修改

### 另一个方法
```R
library(mlbench)
library(caret)
control <- rfeControl(functions=rfFuncs, method="cv", number=10)
# run the RFE algorithm
results <-rfe(data[,-1], data[,1], sizes=c(1:20),rfeControl=control,na.rm=TRUE)
# summarize the results
print(results)
# list the chosen features
predictors(results)
# plot the results
plot(results, type=c("g", "o"))
```