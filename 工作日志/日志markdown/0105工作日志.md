18年论文《Automated Earnings Forecasts》的包装手法

![[( Automated Earnings Forecasts ) 的包装手法]]

2. **SAS改写python代码思路**，还在根据实际情况修改：
``` python
import pandas as pd
import numpy as np

# 使用“NAMES”文件创建8位CUSIP
compcusip = pd.read_csv('d29hqjsbzlgryapk.csv')
compcusip = compcusip[compcusip['tic'].isin(['DELL', 'IBM', 'MSFT', 'F', 'DIS'])]
compcusip['cusip8'] = compcusip['cusip'].str[:8]

# 从“STOCKNAMES”文件中提取CRSP Cusip并删除重复项
crspcusip = pd.read_csv('bs5abohdf4wseqh9.csv', usecols=['cusip', 'permco', 'permno'])
crspcusip.drop_duplicates(subset='cusip', inplace=True)

# 合并Compusat cusip与CRSP cusip并创建表“total”
total = pd.merge(compcusip, crspcusip, on='cusip')

# 提取Compusat数据
# 选择GVKEYS
glist = ['006066', '012141', '014489']

# 适用于FYEAR(财政年度)的日期范围
fyear1 = 1997
fyear2 = 2006

# 所选数据项(自动包含GVKEY、DATADATE、FYEAR和FYR)
vars = ['gvkey', 'fyr', 'fyear', 'datadate', 'SALE', 'AT', 'INDFMT', 'DATAFMT', 'POPSRC', 'CONSOL']

# 从Compustat年度基金文件中提取
compx2 = pd.read_csv('comp.funda', usecols=vars)
compx2 = compx2[compx2['gvkey'].isin(glist) & (compx2['fyear'] >= fyear1) & (compx2['fyear'] <= fyear2) & (compx2['indfmt'] == 'INDL') & (compx2['datafmt'] == 'STD') & (compx2['popsrc'] == 'D') & (compx2['consol'] == 'C')]

# 为会计年度创建开始日期和结束日期
compx2['endfyr'] = pd.to_datetime(compx2['datadate'])
compx2['begfyr'] = compx2['endfyr'] - pd.offsets.MonthBegin(11)

# 计算销售额/资产比率
compx2['sxa'] = compx2['SALE'] / compx2['AT']

# 只保留相关变量
compx2 = compx2[['gvkey', 'begfyr', 'endfyr', 'sxa', 'fyr', 'fyear']]

# 按gvkey和endfyr排序
compx2.sort_values(by=['gvkey', 'endfyr'], inplace=True)

# 链接gvkey到CRSP标识符
# 使用CCMXPF_LNKHIST表获取公司/日期子集的CRSP标识符
mydata = pd.merge(compx2, total, on='gvkey')
# 向合并表中添加CRSP数据
# 提取相关日期和标识符的CRSP数据
crsp = pd.read_csv('crsp.stocknames', usecols=['permno', 'begdate', 'enddate', 'shrcd', 'exchcd'])
crsp = crsp[(crsp['permno'].isin(mydata['permno'])) & (crsp['begdate'].isin(mydata['begfyr'])) & (crsp['enddate'].isin(mydata['endfyr'])) & (crsp['shrcd'].isin([10, 11])) & (crsp['exchcd'].isin([1, 2]))]

# 合并CRSP数据与合并表
mydata = pd.merge(mydata, crsp, on=['permno', 'begdate', 'enddate'])

# 创建包含每日股票回报和市值数据的表格
# 合并CRSP每日股票收益数据与合并表
crsp_m = pd.read_csv('crsp.msf', usecols=['permno', 'date', 'ret', 'shrout', 'prc', 'vwretd'])
crsp_m = crsp_m[(crsp_m['permno'].isin(mydata['permno'])) & (crsp_m['date'].isin(mydata['begfyr'])) & (crsp_m['date'].isin(mydata['endfyr']))]

# 将CRSP每日数据合并到合并表中
mydata = pd.merge(mydata, crsp_m, on=['permno', 'date'])

# 按日期排序最终表
mydata.sort_values(by='date', inplace=True)

# 为数据创建汇总统计信息
summary_stats = mydata.describe()

```
3. **OLS的表的数据整理思路**：
每年每季度对应的财报和对应三个月的股票数据写入一行：
2018年第一季度（2018Q1对应20181月、2月、3月)满足条件的股票信息写入对应行即可