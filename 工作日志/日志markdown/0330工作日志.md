### Morris Introduction
(主要参考Sensitivity analysis using Morris: Just screening or an effective ranking method?中的解释)

为对SA方法进行评估与排名，人们对基于方差的方法和morris方法进行了实验评估。但不同的研究结果并不明显相同，有的对该方法morris评估较好，但有的研究也认为morris方法评估表现较差，这可能是由于不同学科或是SA对不现实的假设的依赖性，大部分研究倾向于是因为当输入变量分布不均匀，或morris低估了某些输入变量与输出变量的之间相关性，尤其当输入和输出变量之间存在较强的非线性时（容易被低估)，导致Morris和基于方差的结果之间存在分歧。

本研究旨在比较Morris和E-FAST方法使用三种通用作物模型。
1. 作物模型具有强非线性；
2. 模型参数之间表现出相关性；
3. 作物模型的校准通常在参数数量和观测值数量之比不利的条件下进行。
使用SA方法可有助于确定特定模型的目标参数，从而降低校准模型时因等效性和过拟合而失去模型稳健型的风险。(Therefore, running SA to identify target parameters for calibration for the pecific conditions of application (SA is situational; Stearns, 1992) reduces the risk of losing robustness because of equifinality and overfitting (Whittaker et al., 2010; Her and Chaubey, 2015).)
本次实验将在校准模型的过程中比较两种方法的性能。

### Morris
该方程计算了在保持所有其他参数不变的情况下，**当第i个参数的值发生变化时，模型输出值将如何变化**
$$
R_i(X,\Delta) =\frac {y(x_1,...,x_{i-1},x_i+\Delta,x_{i+1},...,x_N)-y(X)}{\Delta}
$$

- $X = (x_1, …, x_N)$ : 表示由模型参数组成的向量。它包含N个元素，每个元素$x_i$代表第i个参数的初始值。
- $p$: 每个参数$x_i$将从$\{0,{1\over{p-1}},{2\over{p-1}},...,{p-2\over{p-1}},1\}$中取值，也就是说**每个参数可以取p个不同的值,最小是0，最大是1**。
- $Δ =\frac{1}{(p-1)}$: 这是从上面取值集合中推导所得的，表示第i个参数$x_i$的**每次的变化值**。
- $y(X)$代表模型的**原始输出值**（没有$\Delta$变化时）
- $y(x1，…，xi-1, xi+Δ， xi+1，…，xN):$这表示在保持所有其他参数不变的情况下，当第i个参数变化Δ时模型的输出。
- $Ri(X, Δ)$:表示第i个参数变化时输出值的影响，称之为**初等效应**。它的计算方法是，当第i个参数发生变化时，原始参数值设定时的模型的输出 与第i个参数变化后的输出值之差 除以 Δ（第i个参数的变化量）。

Morris 方法使用以上公式为基础，**识别模型中哪些参数对输出结果影响最大**。
- 其中，Morris方法采用Ω 超空间的概念，简单来说Ω表示**各参数取值范围的集合**。
- 在 Morris 方法中：
	- 首先从上述**各参数取值范围的集合**中随机抽样，用于表示参数空间中的一个点。
	- 接着，变化其中一个参数其余参数保持不变，计算模型输出。
	- 重复上一步，然后更改另一个参数，对模型进行评估。
	- 在每个点上，仅有一个参数被微小地改变（Δ），其他参数保持不变。
	- 一直到所有参数都进行过变化，从而产生一条轨迹。
	- （参考论文：Andersson M, Streb M, Ko J Y, et al. Parametrization of physics-based battery models from input–output data: a review of methodology and current research[J]. Journal of Power Sources, 2022, 521: 230859.）
- 假设采样共形成 r 条轨迹（**进行r次采样**），每个轨迹由 N+1 个点组成。
	- (每个轨迹有一个随机生成的不同初始参数值组成的点，剩下N个分别代表每个参数值进行一次变化，所以是N+1次)
- 相比传统的**逐一变动参数进行敏感度分析方法**，Morris 方法通过在 Ω 超空间中沿着轨迹变动参数（一次变动多个参数，得到r个值）的方式来评估模型，可以更高效地进行敏感度分析。此外，Morris 方法在变动参数时避免了参数重复取值的情况，可以帮助减少敏感度分析中的偏差。
	- 传统的敏感度分析方法通常采用一次只变动一个参数的方式，但是这种方法容易出现误差，因为它没有考虑*不同参数之间的相互作用和非线性效应*。
	- 而Morris方法采用了*多参数同时变动的方式，就可以更全面地考虑参数之间的相互作用和非线性效应。*

- 接着,由于各参数被定义在单位超空间中，即每个参数的取值范围都是$[0,1]$（如上公式），在完成Morris采样后，得到的是每个参数的敏感度指标$R(x_i,\Delta)$，根据指定的参数分布范围从单位超空间缩放回参数原始范围。
- 因此对于每个 $R_i$ 分布，计算其平均值（μ）和标准差（σ），这代表每个参数$x_i$的敏感度度量。平均值（μ）量化了参数对模型输出的总体影响（总敏感度效应），而标准差（σ）则识别了具有非线性影响或参与其他参数交互作用的参数。
	- 标准差通常用于反应数据的离散程度。如果某个参数对模型输出的影响非常不稳定，那么在不同的取值范围会导致模型输出值差异很大，从而导致它$R_i$分布计算出的标准差就会很大。
	- 因此，**标准差越大**，说明参数对模型输出的敏感度越强，也就是，**参数的取值对模型的影响非常明显**，**这个参数对于模型的结果非常关键**。
另外本文中的μ通过对$|R_i|$而不是$R_i$进行平均值计算得出。

- 文章结论：SA实验在不同环境条件下对水稻作物的子模型进行了测试。结果突出显示E-FAST和Morris提供的总体敏感性估计之间缺乏线性关系，尽管在STICS中与作物生长相关的参数和参与物候发育的参数方面，两种方法得到的参数排名的一致性（TDCC）总是在显著性水平0.05下。
	- 使用Morris和E-FAST方法所得到的敏感度估计值之间无线性关系，
	  意思可能是两种方法提供了不同的参数重要性排序结果。

##### Morris简单的代码实现
在python的SALib中可以实现morri算法，其中Sobol序列作为一种经过优化的随机数生成器，能够产生均匀分布的采样点，以在全局范围内更好地探索参数空间。

- 定义初始值这里写作ylab :  $y= X_0 t^2 + X_1 t + X_2$
- 定义采样理论值写作ytheory  :  $y=X_0 t^2 + X_1 t + X_2$
- ylab 与 ytheory之间的平方差记作yerror，记录在数组Y中

```python
#先引入我们需要的包
from SALib.sample import saltelli
from SALib.analyze import sobol
from SALib.analyze import morris
from SALib.test_functions import Ishigami
import numpy as np 
import math 
from SALib.plotting.bar import plot as barplot
import matplotlib.pyplot as plt
import pandas as pd

# 验证的函数是:y=ax^2+bx+cy 
# 这里对函数灵敏度有影响的参数是a , b , c
# 下面事先定义他们的可能的范围
#定义一个字典
problem = {
    'num_vars':3,
    'names':['x1', 'x2', 'x3'],
    'bounds':[[2, 4],[5, 8],[0, 1]]
}

param_values = saltelli.sample(problem,1000)
np.savetxt("param_values.txt", param_values)
#将参数变化保存，其实是个参数范围内的sobol（全局均匀）抽样
# print(param_values.shape)
Y = np.zeros([param_values.shape[0]])
# param_values：参数值

for i,X in enumerate(param_values):
    tarr = np.linspace(0, 1, 3)
    yerror = 0.0;
    for t in tarr:
        ylab = 2*t**2+3*t+4; # 假定的参数值所得y值
        ytheory = X[0]*t**2+X[1]*t+X[2]; # morrir测试的
        yerror = yerror+(ylab-ytheory)**2;
    Y[i] = math.sqrt(yerror);


Si = morris.analyze(problem,param_values,Y,print_to_console=True)
print("the mean elementary effect mu:")
print(Si['mu'])#the mean elementary effect
print("the absolute of the mean elementary effect mu_star:")
print(Si['mu_star'])#the absolute of the mean elementary effect
print("the standard deviation of the elementary effect sigma sigma:")
print(Si['sigma'])#the standard deviation of the elementary effect

from SALib.plotting.bar import plot as barplot
import matplotlib.pyplot as plot
Si_df = Si.to_df()
print(Si_df)
barplot(Si_df)
```
计算出敏感指数的平均灵敏、平均灵敏度的绝对值和灵敏度的标准差
结果如下：
```python
          mu   mu_star     sigma  mu_star_conf
x1  0.183048  3.255688  4.401225      0.137893
x2  0.143914  6.169109  6.212374      0.033500
x3 -0.610358  3.328125  4.378460      0.137083
the mean elementary effect mu:
[ 0.18304814  0.14391386 -0.61035832]
the absolute of the mean elementary effect mu_star:
[3.2556881665404074 6.169109293203692 3.328124741601692]
the standard deviation of the elementary effect sigma sigma:
[4.40122503 6.21237411 4.37845968]
          mu   mu_star     sigma  mu_star_conf
x1  0.183048  3.255688  4.401225      0.137893
x2  0.143914  6.169109  6.212374      0.033500
x3 -0.610358  3.328125  4.378460      0.137083
```
![[研究论文/picture/Figure_2.png]]
$x_1,x_2,x_3$分别对应$y = ax^2+bx+c$中的$a,b,c$

