使用深度学习运行混合频率模型，**处理预测数据表的格式**是关键。
目前表格处理结果如下，表中还需加入月度与宏观数据变量
![[Pasted image 20230213013523.png]]
处理代码：
```python
import pandas as pd
# 1. 真实eps y = ACTUAL
df_act = pd.read_csv('/mnt/eps/all_act_eps.gz')
df_act = df_act.dropna()# 日期格式转换
def convert_date(src_format):
    import datetime
    aim_format = '%Y-%m-%d'
    datetime = datetime.datetime.strptime(src_format, aim_format)
    return datetime.date().strftime('%Y%m%d')
df_act['datadate'] = df_act['FPEDATS'].apply(lambda x: convert_date(x))
# 2. 变量 1：inventory 季度频率数据
df_var1 = pd.read_csv('/mnt/Data_US/src_quarterly/1_inventory.csv',low_memory = False)
def merge_ibes_comp(df_ibes,df_comp):
    df_ibes['cusip'] = df_ibes['CUSIP']
    df_comp = df_comp.drop(columns = 'Unnamed: 0')
    df_comp['cusip'] = df_comp['cusip'].str[:8]
    df_comp['datadate'] = df_comp['datadate'].astype(str)
    df = df_comp.merge(df_ibes, on=['cusip','datadate','fyearq'],how = 'left')
    df = df.drop(columns = ['quarter','month'])
    df['fqtr'] = df['fqtr'].astype(int)
    return df.dropna()
df_y_var1 = merge_ibes_comp(df_act,df_var1)
# 3. 变量 2：accounts receivable 季度频率数据
df_var2 = pd.read_csv('/mnt/Data_US/src_quarterly/2_accounts_receivable.csv',low_memory = False)
def merge_dfnew_dfcomp(df_new,df_comp):
    df_comp = df_comp.drop(columns = 'Unnamed: 0')
    df_comp['datadate'] = df_comp['datadate'].astype(str)
    df = df_new.merge(df_comp,on=['gvkey','datadate','fyearq','fqtr','fyr'],how = 'left')
    df = df.dropna()
    df = df.drop(columns = ['cusip_x'])
    df = df.rename(columns = {'cusip_y':'cusip'})
    return df
df_y_var12 = merge_dfnew_dfcomp(df_y_var1,df_var2)
df_y_var12  = df_y_var12.drop(columns = ['rectq','revtq'])
# 4. 变量 3 ：capital expenditures 季度频率数据
df_var3_1 = pd.read_csv('/mnt/Data_US/src_quarterly/3_capital expenditures(0-1000000).csv',low_memory = False)
df_var3_2 = pd.read_csv('/mnt/Data_US/src_quarterly/3_capital expenditures(1000000-1934410).csv',low_memory = False)
df_var3 = pd.concat([df_var3_1,df_var3_2])
df_var3 = df_var3.dropna()
df_y_var1to3 = merge_dfnew_dfcomp(df_y_var12,df_var3)
# 5. 变量 4 ：gross margin 季度频率数据
df_var4 = pd.read_csv('/mnt/Data_US/src_quarterly/4_gross_margin.csv',low_memory = False)
df_y_var1to4 = merge_dfnew_dfcomp(df_y_var1to3,df_var4)
# 6. 变量 5 ：SG&A 季度频率数据
df_var5 = pd.read_csv('/mnt/Data_US/src_quarterly/5_SGA.csv',low_memory = False)
df_y_var1to5 = merge_dfnew_dfcomp(df_y_var1to4,df_var5)
def dataset_1(df):
    import warnings
    warnings.filterwarnings('ignore') # 忽略警告
    df = df [['gvkey','datadate','fyearq','fqtr','fyr','inventory','ACTUAL','accounts_receivable','capital expenditures','gross_margin','sga']]
    dataset = df [['gvkey','datadate','fyearq','fqtr','fyr']]
    dataset['y'] = df['ACTUAL']
    dataset['var1'] = df['inventory']
    dataset['var2'] = df['accounts_receivable']
    dataset['var3'] = df['capital expenditures']
    dataset['var4'] = df['gross_margin']
    dataset['var5'] = df['sga']
    return dataset
dataset_1(df_y_var1to5)
```