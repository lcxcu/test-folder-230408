1. 发现昨天预测变量3导出部分有些多余行，编写代码对多余行进行删除。 

2. 采用分批计算，计算预测变量6：
- Abnormal stock return
	- **企业的月收益减去当月同行业组合收益**
	- CRSP在第m个月的特定公司股票收益减去第m个月的同行业收益，
	   其中行业分类基于Fama-French 10个行业定义。
	投资组合收益算法采用平均权重Equal-Weighted Return (includes distributions) 

3. 开始着手预测变量7的计算：
- 收益波动率 （Return volatility）
	 - **给定月份内每日股票收益的平方的平均值**
	 - 每日股票收益也采用Equal-Weighted Return(includes distributions) （对应字段：ewretd）

下附预测变量6 计算代码:
```python
# k=6,nrows=100000/200000/300000 第m个月的特定公司股票收益-第m个月的同行业投资组合收益
import pandas as pd
rows = 300000
# 读入crsp文件  第m个月的特定公司股票收益-第m个月的同行业投资组合收益
df_crsp = pd.read_csv("crsp/CRSP_csv/CRSP_csv.csv",usecols=['PERMNO','CUSIP','ewretd','YYYYMMDD','SICCD','Ticker']
                      ,skiprows = [i for i in range(1,rows)],nrows=rows,low_memory=False)
import pandas as pd
# 读入IPortfolios文件
df_IPortfolios = pd.read_csv("10_Industry_Portfolios_CSV/10_Industry_Portfolios.CSV"
                      , skiprows=11 ,low_memory=False)
df_IPortfolios = df_IPortfolios.rename(columns={'Unnamed: 0':'Datadate'})
df_IPortfolios = df_IPortfolios.iloc[0:1157,:] # 只取月度投资组合收益
# 读取其中行业分类
industry = list(df_IPortfolios.columns)[1:-1]
import numpy as np
scope = ["0100-0999\n2000-2399\n2700-2749\n2770-2799\n3100-3199\n3940-3989",
        " 2500-2519\n2590-2599\n3630-3659\n3710-3711\n3714-3714\n3716-3716\n3750-3751\n3792-3792\n3900-3939\n3990-3999",
        "2520-2589\n2600-2699\n2750-2769\n2800-2829\n2840-2899\n3000-3099\n3200-3569\n3580-3621\n3623-3629\n3700-3709\n3712-3713\n3715-3715\n3717-3749\n3752-3791\n3793-3799\n3860-3899",
        "1200-1399\n2900-2999",
        "3570-3579\n3622-3622\n3660-3692\n3694-3699\n3810-3839\n7370-7372\n7373-7373\n7374-7374\n7375-7375\n7376-7376\n7377-7377\n7378-7378\n7379-7379\n7391-7391\n8730-8734",
        "4800-4899",
        "5000-5999\n7200-7299\n7600-7699",
        "2830-2839\n3693-3693\n3840-3859\n8000-8099", 
        "4900-4949"]

def convert_ranges(ranges_string):
    ranges = ranges_string.strip().split("\n")
    result = []
    for r in ranges:
        start, end = r.strip().split("-")
        result.append(range(int(start),int(end)))
    return result

range_list = list(map(lambda x: convert_ranges(x), scope)) # 对应SIC生成的range范围range_list 
industry_dict = dict(zip(industry, range_list))# 将对应行业与range_list的中的范围对应起来
df_crsp['SICCD'] = df_crsp['SICCD'].fillna(0)
def in_ranges(num, ranges): # 判断该代码是否在对应范围中
    if num == np.nan:
        return False
    num = int(num)
    for r in ranges:
        if num in r:
            return True
    return False

def map_industry(code,industry_dict): # 返回对应行业
    for k in industry_dict:
        if in_ranges(code,industry_dict[k]):
            return k
    return np.nan

df_crsp['industry'] = df_crsp['SICCD'].apply(lambda x : map_industry(x,industry_dict))
df_crsp['industry'] = df_crsp['industry'].fillna('Other')
import warnings
warnings.filterwarnings('ignore') # 忽略警告
df_IPortfolios['fyearq'] = df_IPortfolios['Datadate'].str[:4].astype(int)
df_IPortfolios['month'] = df_IPortfolios['Datadate'].str[4:].astype(int)
df_crsp['YYYYMMDD'] = df_crsp['YYYYMMDD'].astype(str)
df_crsp['fyearq'] = df_crsp['YYYYMMDD'].str[:4].astype(int)
df_crsp['month'] = df_crsp['YYYYMMDD'].str[4:6].astype(int)
df_crsp['day'] = df_crsp['YYYYMMDD'].str[6:].astype(int)
def convert_date(src_format):
    import datetime
    aim_format = '%Y%m%d'
    datetime = datetime.datetime.strptime(src_format, aim_format)
    return datetime.date()
df_crsp['YYYYMMDD'] = df_crsp['YYYYMMDD'].apply(lambda x: str(convert_date(x)))
df_crsp['YYYYMMDD'] = pd.to_datetime(df_crsp['YYYYMMDD'] )
df_crsp.set_index('YYYYMMDD', drop=True, append=False, inplace=True)
def sum_by_monthly(group):
    # 定义按月加总函数
    return group['ewretd'].resample('M').sum()

grouped = df_crsp.groupby('CUSIP')
df_stock_income = grouped.apply(sum_by_monthly)
df_stock_income = pd.DataFrame(df_stock_income)
df_crsp = df_crsp.merge(df_stock_income,on=['CUSIP','YYYYMMDD'],how = 'left')
df_crsp = df_crsp.dropna(how='any')
df_crsp = df_crsp.drop(columns='ewretd_x')
df_crsp.rename(columns={'ewretd_y':'stock_income'}, inplace = True)
df = df_crsp.merge(df_IPortfolios,on =['fyearq','month'],how = 'left')
df['industry_income'] = [df[df['industry'][i]] [i] for i in range(len(df))] 
df_crsp = df.drop(columns = list(df_IPortfolios.columns[0:-2]))
k = 6
var1 = 'stock_income'
var2 = 'industry_income'
new_var = 'Abnormal_stock_return'
# 定义日期范围
fyear1 = 1984
fyear2 = 2014
df_crsp2 = df_crsp.dropna() 
df_crsp2['delta_'+var1] = df_crsp2[var1].diff()
df_crsp2['delta_'+var2] = df_crsp2[var2].astype(float).diff()
df_crsp[new_var] = df_crsp2['delta_'+var1]-df_crsp2['delta_'+var2]
df_crsp2 = df_crsp2.drop(columns=[var1,var2,'delta_'+var1,'delta_'+var2])
df_crsp2 = df_crsp2[(df_crsp2["fyearq"] >= fyear1) & (df_crsp2["fyearq"] <= fyear2)]
df_crsp2.to_csv("src_monthly/"+str(k)+"_"+new_var+"(300000-400000).csv")

```