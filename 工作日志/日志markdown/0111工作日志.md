**多次实验得出的短期结论：**
使用ols对u-midas模型进行预测的话，在特征选择中似乎并没有办法得到一个准确的结果究竟是**哪一段时间**对股票具有解释力。

**模型使用方面：**
现在所实验的u-midas模型不仅预测时表现出高频数据解释力不强，可代入的实验数据量也受到极大限制。
```R
eq_r2_trend <- lm(yy ~ mls(yy, 1:3, m = 1)  + mls(xx, 0:20,90) + trend )
summary(eq_r2_trend)
```
![[Pasted image 20230112015147.png|400]]

**目前从图形上得到的预测较好的模型仍是过去使用日度数据、频率为84天受限制的midas模型，其中高频数据的解释力也是较强的(如下）。**

```R
eq_r2<- midas_r(yy ~ mls(yy, 1:3, m = 1) + mls(xx, 84:335, 84, nbeta) , start = list(xx= c(1.7, 1,5)))
summary(eq_r2)
```
![[Pasted image 20221219030440.png]]
```R
eq_r3 <- midas_r(yy ~ mls(yy, 1:3, m = 1) + mls(xx, 84:419, 84, nbeta) , start = list(xx= c(1.7, 1,5)))
```
![[Pasted image 20221219025000.png]]

**数据或许仍是需要严格处理的：** 考虑到现在使用的数据并没有严格控制每月30天的数据，而是保留原来的有28、30、31天，也就是倍差未严格控制的问题，因此数据是不准确的，或许在使用准确的数据后，模型中高频变量的解释性会得到改善。

总之，目前可证明**高频数据具有解释力**的变量仍是**使用受限制的midas模型在对高频数据聚合后得出的新变量** 

如：
```R
eq_r2<- midas_r(yy ~ mls(yy, 1:3, m = 1) + mls(xx, 90:360, 90, nbeta) , start = list(xx= c(1.7, 1,5)))
```
![[Pasted image 20230112032554.png]]
或者
```R
eq_r <- midas_r(yy ~ mls(yy, 1:3, m = 1) + mls(xx, 90:360, 90, nbeta) , start = list(xx= c(1.7, 1,5)))
```
![[Pasted image 20230112032626.png]]


(考虑到数据不严格的影响，明天会使用严格的数据，再重复进行一次受限制的midas与不受限制的u-midas的实验)


---
==实验及相应结果：==
## 将预测目标从earning改为rate of earning change

```R
# 1 数据导入
library(Boruta)
library(mlbench)
library(caret)
library(randomForest)
data_all <- read.csv("G:\\Data\\midar_data\\src_data\\Result.csv",sep=',' , encoding='UTF-8')
## 删除前5列和第1到lag（最大滞后期）行
lag <- 20
mydata <- data_all[-c(1:lag), -(1:5)]
mydata <- na.omit(mydata)
## 将Erana列进行差分，第一个数是2001第四季度与2002第一季度财报差分值
data<- mydata[!duplicated(mydata$Erana),]
data$Erana <- c (diff(c(0.21,0.09)),diff(data$Erana))
## 保留第一个重复/去所有的重复
rownames(data)<-1:nrow(data)
# 2 特征选择
set.seed(123)
boruta <- Boruta(Erana ~ ., data = data, doTrace = 2, maxRuns = 500)
print(boruta)
```

采用0~20的滞后期的股票涨跌幅预测财报变化结果：
```R
Boruta performed 19 iterations in 8.254538 mins.
 21 attributes confirmed important: stock0, stock1,
stock10, stock11, stock12 and 16 more;
 No attributes deemed unimportant.
```
没有找出特别有解释力的特征，数据都很重要

## 将滞后期长度进行修改
1. 采用0~50个滞后时期的股票涨跌幅
结果是**0到50**个滞后期中的股票数据都很重要
```R
Boruta performed 47 iterations in 33.92188 mins.
 51 attributes confirmed important: stock0, stock1,
stock10, stock11, stock12 and 46 more;
 No attributes deemed unimportant.
```

2. 采用50~100个滞后时期的股票涨跌幅:结果是**50到100**个滞后期中的股票数据都很重要，仍然无法选出最具有解释性的时间段的股票涨跌幅
```R
Boruta performed 71 iterations in 49.97957 mins.
 51 attributes confirmed important: stock100,
stock50, stock51, stock52, stock53 and 46 more;
 No attributes deemed unimportant.
```

3. 50个滞后运行时间太长，还是把时间段改为20个时期运行效率高： 采用**20~40**个滞后时期的股票涨跌幅:结果同上
```R
Boruta performed 12 iterations in 4.094648 mins.
 21 attributes confirmed important: stock20, stock21,
stock22, stock23, stock24 and 16 more;
 No attributes deemed unimportant.
```

4. **100到120**以及**120到140**结果同上
```R
Boruta performed 12 iterations in 4.422414 mins.
 21 attributes confirmed important: stock120,
stock121, stock122, stock123, stock124 and 16 more;
 No attributes deemed unimportant.
```


#### 从模型上进行检查
模型拟合出来是简单的线性回归模型,用于预测效果是不佳的
```R
Erana ~ stock20 + stock21 + stock22 + stock23 + stock24 + stock25 + 
    stock26 + stock27 + stock28 + stock29 + stock30 + stock31 + 
    stock32 + stock33 + stock34 + stock35 + stock36 + stock37 + 
    stock38 + stock39 + stock40
```
以取**20到40**个滞后时间段的模型为例：
```R
Call:
 randomForest(formula = Erana ~ ., data = train) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 1.473935
                    % Var explained: -1.3
```
表示回归模型解释的变量百分比，显示为负数
这意味着该模型并没有解释变量的变化

以取**0到20**个滞后时间段的模型为例也是同样
```R
Call:
 randomForest(formula = Erana ~ ., data = train) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 1.469525
                    % Var explained: -1
```

#### 采用midas模型与boruta算法相结合

```R
## 使用ols估计u-midas
eq_r<- lm(yy ~ mls(xx, 0:30,90))
		summary(eq_r)
```
![[1673459692171.png|400]]

前面的特征选取是用了所有（已知5000多只）股票的数据，现在采用随机选取 **600567**代码数据进行拟合实验
```R
# 导入响应包
library(Boruta)
# 创建矩阵
lag <- 300
data_col <- c("yy",paste0("xx.", 0:lag, "/m"))
data <- matrix(yy, nrow = length(yy), ncol = length(data_col), byrow = FALSE)
colnames(data) <- data_col
data <- data.frame(yy,mls(xx, 0:lag,90))
data <- na.omit(data)
boruta <- Boruta(yy ~ ., data = data, doTrace = 2, maxRuns = 500)
print(boruta)
```
取0~30个滞后
```R
Boruta performed 29 iterations in 0.5906289 secs.
 1 attributes confirmed important: X.0.m;
 30 attributes confirmed unimportant: X.1.m, X.10.m, X.11.m, X.12.m, X.13.m and 25 more;
```
0~120个滞后
```R
Boruta performed 103 iterations in 2.043031 secs.
 5 attributes confirmed important: X.0.m, X.111.m, X.46.m, X.80.m, X.81.m;
 116 attributes confirmed unimportant: X.1.m, X.10.m, X.100.m, X.101.m, X.102.m and 111 more;
```
0~300个滞后
```R
Boruta performed 499 iterations in 11.02291 secs.
 9 attributes confirmed important: X.0.m, X.179.m, X.181.m, X.201.m, X.215.m and 4 more;
 291 attributes confirmed unimportant: X.1.m, X.10.m, X.100.m, X.101.m, X.102.m and 286 more;
 1 tentative attributes left: X.74.m;
```
再随机选取代码 **600684**的公司取0~300天进行实验：
```R
Boruta performed 499 iterations in 9.468818 secs.
 5 attributes confirmed important: X.153.m, X.168.m, X.265.m, X.293.m, X.7.m;
 295 attributes confirmed unimportant: X.0.m, X.1.m, X.10.m, X.100.m, X.101.m and 290 more;
 1 tentative attributes left: X.250.m;
```
