- 基准模型
$$\Delta \hat{E}_{f,q,h}^{Analyst} = \hat{E}_{f,q,h}^{Analyst} - E_{q-1}$$
使用 <u>国泰安</u> 收集的**所有个人分析师 估计的年度每股收益 EPS的中位数**，并将其**取一阶差分**
公司$f$的第$q$年度所有分析师最近的 EPS 估计的中位数减去 I/B/E/S 报告的上一财政年度的拆分调整后的**实际年度** EPS 值
```python 
# C:\Users\jc\Desktop\国泰安\Analyst_data.py
import pandas as pd
import numpy as np
import warnings
# 开始数据导入
warnings.filterwarnings('ignore') # 忽略警告
xlsx_src = ["Analyst_data\AF_Forecast"+str(i)+".csv" 
            for i in range(1,4)]
af_forcasts = [pd.DataFrame() for i in range(0,3)]
for i in range(0,3):
    af_forcasts[i] = pd.read_csv(xlsx_src[i],
                            header=0,
                            usecols=[0,2,8])
af_forcasts = pd.concat(af_forcasts)

xlsx_src = "earning_data\IAR_Rept.csv"
iar_rept = pd.read_csv(xlsx_src, header=0, usecols=[0, 3, 5])
iar_rept = iar_rept.rename(columns={'Accper': 'Fenddt'})
iar_rept['Fenddt'] = pd.to_datetime(iar_rept['Fenddt'])
# # 根据Stkcd和Fenddt对数据进行分组，并找到每组Feps值的中位数
af_median = af_forcasts.groupby(['Stkcd', 'Fenddt'])['Feps'].median()
af_median = af_median.reset_index()
af_median['Fenddt'] = pd.to_datetime(af_median['Fenddt'])
# # 使用merge连接Stkcd和Fenddt相同的af_forcasts和iar_rept
merged_df = pd.merge(af_median, iar_rept, on=['Stkcd', 'Fenddt'])
merged_df['difference'] = merged_df['Feps'] - merged_df['Erana']
merged_df.to_csv(r"consequence\analyst_and_real.csv")
```

- 日度股票数据预测
$$
\Delta E_q = \alpha + \sum_{i = 1+h/3}^{I^*} \Phi_i \cdot \Delta E_{q-i} + \sum_{j = h/3}^{J^*}\ \sum_{m = 1}^{3} \theta_{q-j,m} \cdot X_{q-j,m}^k + \epsilon_{q'}
\qquad
\text{(ADL-MIDAS model)}
$$

其中，$\Delta E_q$为本年度每股收益q与上年度每股收益q-1的差值;
$x_{q,m}$是高频股票数据;$\alpha$、$\Phi_i$和$\theta_{q,m}$为模型参数;$I^*$和$J^*$分别为模型中包含的$\Delta E_q$和$X_{q,m}$的滞后季数，**均使用BIC进行选取**。与(AR模型)一样，(ADL-MIDAS模型)中包含的$ΔE_{q-i}$的第一个滞后值取决于预测期景h (即i=1+h/3)
对于每个独特的观察值(公司$f$、季度$g$和预测水平$h$)，我们使用公司<u>最近40个财政季度</u>的**滚动窗口样本**，通过普通最小二乘(OLS)估计(ADL-MIDAS模型)参数。
得到的ADL-MIDAS预测$\Delta \hat{E}_{f,q,h'}^k$等于估计模型在季度q的样本外预测值。

相比之前的模型需要测试一下几点：
1. 如果改成预测年度收益的话，模型频率倍差（可能从之前的28x3改成28x3x4）需要改变一下
2. 测试一下最多到多少多少滞后期，模型会跑不出结果
```python
eq_r <- midas_r(yy ~ mls(yy, 1:3, m = 1) + mls(xx, 84:419, 84, nbeta) , start = list(xx= c(1.7, 1,5)))
```
暂时是取ADL-MIDAS模型中，季度财报取滞后1到3个季度，日度股票取滞后1到5个季度，但在年度估计上的话滞后期数的取值还需要实验。